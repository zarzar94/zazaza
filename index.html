<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دليلي - نظام الخدمات الضريبية والمالية</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Arial', system-ui, -apple-system, sans-serif;
            background: #1a5450;
            color: #c9b037;
            overflow: hidden;
            position: relative;
            direction: rtl;
        }

        /* Game Canvas */
        #gameCanvas {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1a5450 0%, #0f3835 50%, #1a5450 100%);
            overflow: hidden;
        }

        /* Islamic Pattern Background */
        /*
         * Replace the inline SVG pattern with a high‑resolution geometric
         * texture. The image lives in the same folder as this file and is
         * renamed to a simple ASCII filename (pattern‑bg.png) for ease of
         * reference. We hide the fallback SVG entirely. Increasing the
         * opacity makes the background pattern more visible while still
         * allowing the interactive elements to stand out.  On mobile the
         * pattern scales gracefully because of background‑size: cover.
         */
        .pattern-background {
            /* The background pattern overlay sits above the game floor but below UI elements */
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1;
            /* Use the white Islamic pattern on a transparent background */
            /* Use the new white Islamic pattern on a transparent background */
            background-image: url('pattern-white-converted.png');
            /* Repeat the pattern so it tiles across the entire viewport */
            background-repeat: repeat;
            /* Control the size of each tile to achieve a balanced look across devices.  Large screens see a larger tile; small screens see smaller tiles. */
            /* Default pattern tile size for large screens */
            background-size: 600px auto;
            /* Align the pattern tiles to the top-left to avoid visible seams when repeating */
            background-position: left top;
            /* Lower opacity so the pattern remains subtle behind the UI */
            opacity: 0.12;
        }

        /* Adjust pattern size on smaller screens so it remains elegant and not overwhelming */
        @media (max-width: 1200px) {
            .pattern-background {
                background-size: 500px auto;
            }
        }
        @media (max-width: 768px) {
            .pattern-background {
                background-size: 400px auto;
            }
        }
        @media (max-width: 480px) {
            .pattern-background {
                background-size: 300px auto;
            }
        }

        /* hide the inline SVG that was previously used */
        .pattern-background svg {
            display: none;
        }

        /* Grid Floor with Pattern */
        .game-floor {
            position: absolute;
            width: 200%;
            height: 200%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotateX(60deg) translateZ(-100px);
            transform-style: preserve-3d;
            pointer-events: none;
            /* lower z-index so the background Islamic pattern can sit above this layer */
            z-index: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cdefs%3E%3ClinearGradient id='patternGrad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%234dd0e1;stop-opacity:0.1'/%3E%3Cstop offset='50%25' style='stop-color:%23ffd700;stop-opacity:0.05'/%3E%3Cstop offset='100%25' style='stop-color:%234dd0e1;stop-opacity:0.1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cg fill='none' stroke='url(%23patternGrad)' stroke-width='0.5'%3E%3Cpath d='M50,0 L50,50 L0,50 M50,50 L100,50 L100,0 M100,50 L100,100 L50,100 M100,100 L150,100 L150,50 M150,100 L150,150 L100,150 M150,150 L200,150 L200,100'/%3E%3Ccircle cx='50' cy='50' r='20'/%3E%3Ccircle cx='100' cy='50' r='20'/%3E%3Ccircle cx='150' cy='50' r='20'/%3E%3Ccircle cx='50' cy='100' r='20'/%3E%3Ccircle cx='100' cy='100' r='20'/%3E%3Ccircle cx='150' cy='100' r='20'/%3E%3Ccircle cx='50' cy='150' r='20'/%3E%3Ccircle cx='100' cy='150' r='20'/%3E%3Ccircle cx='150' cy='150' r='20'/%3E%3Cpath d='M25,25 L75,25 L75,75 L25,75 Z M75,25 L125,25 L125,75 L75,75 Z M125,25 L175,25 L175,75 L125,75 Z M25,75 L75,75 L75,125 L25,125 Z M75,75 L125,75 L125,125 L75,125 Z M125,75 L175,75 L175,125 L125,125 Z M25,125 L75,125 L75,175 L25,175 Z M75,125 L125,125 L125,175 L75,175 Z M125,125 L175,125 L175,175 L125,175 Z'/%3E%3C/g%3E%3C/svg%3E");
            background-size: 150px 150px;
            animation: patternShift 30s linear infinite;
        }

        @keyframes patternShift {
            from { background-position: 0 0; }
            to { background-position: 150px 150px; }
        }

        .grid-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* Further lighten the grid overlay so the background pattern is more visible
               across devices. Lower alpha values create a subtler grid and allow
               the golden Islamic motif to shine through. */
            background: linear-gradient(0deg, 
                rgba(10, 22, 40, 0.2) 0%, 
                transparent 20%, 
                transparent 80%, 
                rgba(10, 22, 40, 0.2) 100%);
        }

        /* Central Compass */
        .compass-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
            z-index: 200;
            pointer-events: none;
        }

        /* Glass Sphere */
        .compass-sphere {
            position: absolute;
            width: 200px;
            height: 200px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, 
                rgba(255, 255, 255, 0.3), 
                rgba(173, 216, 230, 0.15) 30%,
                rgba(77, 208, 225, 0.1) 50%, 
                rgba(30, 58, 95, 0.4) 100%);
            box-shadow: 
                inset -25px -25px 0 rgba(0, 0, 0, 0.2),
                inset 25px 25px 0 rgba(255, 255, 255, 0.1),
                0 5px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Glass Reflection */
        .compass-sphere::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 15%;
            width: 35%;
            height: 30%;
            background: radial-gradient(ellipse at center,
                rgba(255, 255, 255, 0.4),
                rgba(255, 255, 255, 0.1) 50%,
                transparent 70%);
            border-radius: 50%;
            transform: rotate(-20deg);
        }

        /* Ornate Outer Ring */
        .compass-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .compass-ring svg {
            width: 100%;
            height: 100%;
        }

        /* Compass Star Needle */
        .compass-needle {
            position: absolute;
            width: 120px;
            height: 120px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
            z-index: 10;
        }

        .compass-needle svg {
            width: 100%;
            height: 100%;
        }

        /* Cardinal Points */
        .cardinal-points {
            position: absolute;
            width: 100%;
            height: 100%;
            font-size: 16px;
            font-weight: bold;
        }

        .cardinal-point {
            position: absolute;
            color: #ffd700;
            font-family: 'Georgia', serif;
            font-weight: bold;
        }

        .cardinal-point.north { top: -10px; left: 50%; transform: translateX(-50%); }
        .cardinal-point.south { bottom: -10px; left: 50%; transform: translateX(-50%); }
        .cardinal-point.east { right: -10px; top: 50%; transform: translateY(-50%); }
        .cardinal-point.west { left: -10px; top: 50%; transform: translateY(-50%); }

        /* Player Avatar */
        #player {
            position: absolute;
            width: 30px;
            height: 30px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            transition: none;
        }

        .player-body {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #4dd0e1, #00a6b8);
            border-radius: 50%;
            box-shadow: 0 0 0 3px rgba(77, 208, 225, 0.8);
            animation: playerGlow 2s ease-in-out infinite;
        }

        @keyframes playerGlow {
            0%, 100% { 
                box-shadow: 0 0 0 3px rgba(77, 208, 225, 0.8);
            }
            50% { 
                box-shadow: 0 0 0 5px rgba(77, 208, 225, 1);
            }
        }

        /* Service Node Container */
        .service-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        /* Service Nodes with Gold Text */
        .service-node {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: radial-gradient(circle, #1a5450 0%, #0f3835 100%);
            border: 3px solid #c9b037;
            position: relative;
            box-shadow: 0 5px 0 rgba(0, 0, 0, 0.3);
        }

        .service-node.active {
            transform: scale(1.1);
            border-color: #ffd700;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.8);
            background: radial-gradient(circle, #2a6460 0%, #1a5450 100%);
        }

        .service-node:hover {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.6);
            border-color: #ffd700;
        }

        .node-icon {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        /* Special animation for Virtual Assistant icon */
        .service-node[data-service="assistant"] .node-icon {
            animation: assistantPulse 2s ease-in-out infinite;
        }

        @keyframes assistantPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .node-title {
            font-size: 0.82em;
            text-align: center;
            color: #ffd700;
            padding: 0 8px;
            font-weight: 600;
            line-height: 1.2;
        }

        /* Info Box - Professional Ministry Design */
        .node-info {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 40px;
            border-radius: 12px;
            width: 500px;
            max-width: 90vw;
            border: 2px solid #1a5450;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 10000;
            overflow: visible;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15),
                        0 0 0 1px rgba(26, 84, 80, 0.1);
        }

        /* Ministry Header Strip */
        .node-info::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #1a5450 0%, #c9b037 50%, #1a5450 100%);
            border-radius: 12px 12px 0 0;
        }

        .service-node.selected .node-info {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
            animation: modalSlideIn 0.4s ease-out;
        }

        @keyframes modalSlideIn {
            0% {
                transform: translate(-50%, -60%) scale(0.95);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        /* Close button for info box */
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 32px;
            height: 32px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 18px;
            color: #6c757d;
            font-weight: bold;
            z-index: 10;
        }

        .close-button:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            color: #495057;
            transform: rotate(90deg);
        }

        /* Ministry Logo Section */
        .ministry-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .ministry-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1a5450 0%, #0f3835 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .ministry-text {
            text-align: right;
        }

        .ministry-name {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 3px;
            font-weight: 500;
        }

        .ministry-system {
            font-size: 1.1em;
            color: #1a5450;
            font-weight: 700;
        }

        /* Dark overlay when info is shown */
        .info-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 9999;
            pointer-events: none;
        }

        .info-overlay.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            animation: fadeIn 0.3s ease;
        }

        /* Top header bar for logos. The bar spans the full width and adapts to
           different screen sizes. Logos are centered with a small gap and
           scale with viewport height. Using pointer-events: none allows
           interactive elements beneath to remain accessible. */
        .header-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            /* distribute the two logos across the bar */
            justify-content: space-between;
            align-items: center;
            padding: 0.5em 1em;
            /* keep the header bar green with slight transparency so it stands out against the page */
            background: rgba(26, 84, 80, 0.9);
            border-bottom: 2px solid #c9b037;
            z-index: 10002;
            pointer-events: none;

            /* force left-to-right ordering for the logo images regardless of page direction */
            direction: ltr;
        }
        .header-bar img {
            /* allow the logos to scale with the viewport height */
            height: 6vh;
            width: auto;
            object-fit: contain;
        }
        @media (max-width: 768px) {
            .header-bar {
                /* keep a horizontal layout on small screens but reduce padding */
                flex-direction: row;
                padding: 0.4em 1em;
            }
            .header-bar img {
                height: 5vh;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .node-info-title {
            color: #1a5450;
            font-size: 1.5em;
            margin-bottom: 15px;
            font-weight: 700;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
            letter-spacing: 0.5px;
        }

        .node-info-content {
            color: #495057;
            line-height: 1.8;
            font-size: 1em;
            text-align: right;
            margin: 20px 0;
            font-weight: 400;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-right: 4px solid #c9b037;
        }

        /* Service Button - Professional Style */
        .service-button {
            display: block;
            width: 100%;
            margin: 25px auto 0;
            padding: 14px 28px;
            background: linear-gradient(135deg, #1a5450 0%, #0f3835 100%);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(26, 84, 80, 0.3);
            text-decoration: none;
            text-align: center;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .service-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .service-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 84, 80, 0.4);
            background: linear-gradient(135deg, #0f3835 0%, #1a5450 100%);
        }

        .service-button:hover::before {
            left: 100%;
        }

        .service-button:active {
            transform: translateY(0);
        }

        .service-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Service Icon Container */
        .service-icon-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .service-icon-bg {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 3px solid #c9b037;
        }

        /* Info Footer */
        .info-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #6c757d;
        }

        .footer-version {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .footer-support {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .footer-support:hover {
            color: #1a5450;
        }

        /* Security Badge */
        .security-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            padding: 8px 15px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 20px;
            font-size: 0.9em;
            color: #2e7d32;
            border: 1px solid #81c784;
        }

        .security-badge::before {
            content: '🔒';
            font-size: 1.1em;
        }

        /* Distance Indicator */
        .distance-ring {
            position: absolute;
            width: 300px;
            height: 300px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px dashed rgba(77, 208, 225, 0.2);
            border-radius: 50%;
            pointer-events: none;
            z-index: 50;
        }

        /* UI Overlay */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 150;
        }

        /* Header with Gold Text */
        .game-header {
            position: absolute;
            top: 20px;
            right: 20px;
            pointer-events: auto;
            text-align: right;
        }

        .game-title {
            font-size: 2.5em;
            background: linear-gradient(135deg, #c9b037, #f9e79f, #c9b037);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .game-subtitle {
            color: rgba(201, 176, 55, 0.8);
            font-size: 0.9em;
        }

        .compass-direction {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 56, 53, 0.9);
            padding: 10px 30px;
            border-radius: 25px;
            border: 1px solid rgba(201, 176, 55, 0.3);
            color: #c9b037;
            font-size: 1.1em;
            text-align: center;
            pointer-events: none;
        }

        /* Floating Particles */
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #4dd0e1;
            border-radius: 50%;
            pointer-events: none;
            animation: float 15s infinite linear;
        }

        @keyframes float {
            from {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            to {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }

        /* Stars */
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Mobile Controls */
        .mobile-controls {
            display: none;
            position: absolute;
            bottom: 60px;
            right: 20px;
            pointer-events: auto;
        }

        /* Wizard Modal Styles */
        .wizard-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 40px;
            border-radius: 12px;
            width: 600px;
            max-width: 90vw;
            max-height: 85vh;
            overflow-y: auto;
            border: 2px solid #1a5450;
            z-index: 10002;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15),
                        0 0 0 1px rgba(26, 84, 80, 0.1);
        }

        .wizard-modal::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #1a5450 0%, #c9b037 50%, #1a5450 100%);
            border-radius: 12px 12px 0 0;
        }

        /* Progress Bar */
        .wizard-progress {
            display: flex;
            justify-content: space-between;
            margin: 20px 0 30px;
            padding: 0 20px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .progress-step::before {
            content: '';
            position: absolute;
            top: 15px;
            left: -50%;
            right: 50%;
            height: 2px;
            background: #dee2e6;
            z-index: -1;
        }

        .progress-step:first-child::before {
            display: none;
        }

        .progress-step.active::before,
        .progress-step.completed::before {
            background: #c9b037;
        }

        .progress-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .progress-step.active .progress-circle {
            background: #c9b037;
            color: white;
        }

        .progress-step.completed .progress-circle {
            background: #28a745;
            color: white;
        }

        .progress-label {
            font-size: 0.75em;
            color: #6c757d;
            text-align: center;
        }

        .progress-step.active .progress-label {
            color: #1a5450;
            font-weight: 600;
        }

        /* Wizard Steps */
        .wizard-step {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .wizard-step.active {
            display: block;
        }

        .wizard-title {
            color: #1a5450;
            font-size: 1.6em;
            margin-bottom: 20px;
            font-weight: 700;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .wizard-subtitle {
            color: #6c757d;
            font-size: 1em;
            text-align: center;
            margin-bottom: 25px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-label.required::after {
            content: ' *';
            color: #dc3545;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            font-size: 0.95em;
            color: #495057;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 6px;
            transition: all 0.2s ease;
            direction: rtl;
            text-align: right;
        }

        .form-control:focus {
            outline: none;
            border-color: #1a5450;
            box-shadow: 0 0 0 3px rgba(26, 84, 80, 0.1);
        }

        .form-control.error {
            border-color: #dc3545;
        }

        .form-error {
            color: #dc3545;
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }

        .form-control.error + .form-error {
            display: block;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        select.form-control {
            cursor: pointer;
        }

        /* Radio Groups */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .radio-option:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .radio-option input[type="radio"] {
            margin-left: 10px;
            cursor: pointer;
        }

        .radio-option.selected {
            background: #e7f5ff;
            border-color: #1a5450;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-left: 10px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .checkbox-group label {
            cursor: pointer;
            color: #495057;
            flex: 1;
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-upload-area:hover {
            border-color: #adb5bd;
            background: #e9ecef;
        }

        .file-upload-area.drag-over {
            border-color: #1a5450;
            background: #e7f5ff;
        }

        .file-upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .file-name {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .file-remove {
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            transition: transform 0.2s;
        }

        .file-remove:hover {
            transform: scale(1.2);
        }

        /* Alternative Channels */
        .alt-channels {
            background: #fff4e5;
            border-right: 4px solid #ffc107;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .alt-channels-title {
            color: #856404;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alt-channel-item {
            margin: 10px 0;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alt-channel-item a {
            color: #0066cc;
            text-decoration: none;
            font-weight: 500;
        }

        .alt-channel-item a:hover {
            text-decoration: underline;
        }

        /* Collapsible Guidance */
        .guidance-section {
            margin: 20px 0;
        }

        .guidance-header {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .guidance-header:hover {
            background: #e9ecef;
        }

        .guidance-header::after {
            content: '▼';
            transition: transform 0.3s;
        }

        .guidance-header.open::after {
            transform: rotate(180deg);
        }

        .guidance-content {
            padding: 15px;
            display: none;
            color: #6c757d;
            line-height: 1.6;
        }

        .guidance-content.open {
            display: block;
        }

        /* Review Section */
        .review-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .review-section-title {
            color: #1a5450;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .review-item {
            display: flex;
            margin: 8px 0;
        }

        .review-label {
            color: #6c757d;
            min-width: 120px;
            font-weight: 500;
        }

        .review-value {
            color: #495057;
            flex: 1;
        }

        .review-edit {
            color: #0066cc;
            cursor: pointer;
            margin-right: 10px;
            font-size: 0.9em;
        }

        .review-edit:hover {
            text-decoration: underline;
        }

        /* Success Message */
        .success-container {
            text-align: center;
            padding: 40px 20px;
        }

        .success-icon {
            font-size: 4em;
            color: #28a745;
            margin-bottom: 20px;
        }

        .success-title {
            color: #1a5450;
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .success-message {
            color: #495057;
            font-size: 1.1em;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .reference-number {
            background: #e7f5ff;
            border: 2px solid #1a5450;
            border-radius: 8px;
            padding: 15px 25px;
            display: inline-block;
            margin: 20px 0;
        }

        .reference-label {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .reference-value {
            color: #1a5450;
            font-size: 1.5em;
            font-weight: bold;
            letter-spacing: 2px;
        }

        /* Navigation Buttons */
        .wizard-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .wizard-nav-left,
        .wizard-nav-right {
            display: flex;
            gap: 10px;
        }

        .btn-prev,
        .btn-next,
        .btn-submit,
        .btn-close {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-prev {
            background: #6c757d;
            color: white;
        }

        .btn-prev:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-next,
        .btn-submit {
            background: linear-gradient(135deg, #1a5450 0%, #0f3835 100%);
            color: white;
        }

        .btn-next:hover:not(:disabled),
        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 84, 80, 0.4);
        }

        .btn-close {
            background: #28a745;
            color: white;
        }

        .btn-close:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-prev:disabled,
        .btn-next:disabled,
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .joystick {
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(77, 208, 225, 0.3);
            border-radius: 50%;
            position: relative;
            touch-action: none;
        }

        .joystick-knob {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #4dd0e1, #00a6b8);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 0 2px rgba(77, 208, 225, 0.6);
        }

        @media (max-width: 768px) {
            .mobile-controls {
                display: block;
            }
            
            .game-title {
                font-size: 1.8em;
            }
            
            .compass-container {
                width: 200px;
                height: 200px;
            }
            
            .service-node {
                width: 100px;
                height: 100px;
            }
            
            .node-icon {
                font-size: 2em;
            }
            
            .node-title {
                font-size: 0.72em;
            }

            .node-info {
                width: 350px;
                padding: 25px;
            }
            
            .ministry-header {
                flex-direction: column;
                text-align: center;
            }
            
            .ministry-logo {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .ministry-text {
                text-align: center;
            }
            
            .node-info-title {
                font-size: 1.3em;
            }
            
            .node-info-content {
                font-size: 0.95em;
                padding: 15px;
                text-align: center;
            }
            
            .service-button {
                font-size: 1em;
                padding: 12px 20px;
            }
            
            .service-icon-bg {
                width: 70px;
                height: 70px;
            }
            
            .info-footer {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .security-badge {
                font-size: 0.85em;
                padding: 6px 12px;
            }
            
            .close-button {
                width: 28px;
                height: 28px;
                top: 15px;
                right: 15px;
                font-size: 16px;
            }
            
            /* Wizard Mobile Styles */
            .wizard-modal {
                width: 95vw;
                padding: 25px;
                max-height: 90vh;
            }
            
            .wizard-progress {
                padding: 0 10px;
            }
            
            .progress-label {
                display: none;
            }
            
            .wizard-title {
                font-size: 1.3em;
            }
            
            .wizard-subtitle {
                font-size: 0.9em;
            }
            
            .radio-option {
                padding: 10px;
                font-size: 0.9em;
            }
            
            .alt-channels {
                font-size: 0.85em;
                padding: 12px;
            }
            
            .review-section {
                padding: 15px;
            }
            
            .review-label {
                min-width: 80px;
                font-size: 0.9em;
            }
            
            .btn-prev,
            .btn-next,
            .btn-submit,
            .btn-close {
                padding: 10px 20px;
                font-size: 0.9em;
            }
            
            .wizard-nav {
                flex-direction: column-reverse;
                gap: 10px;
            }
            
            .wizard-nav-left,
            .wizard-nav-right {
                width: 100%;
            }
            
            .wizard-nav button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="gameCanvas">
        <!-- Islamic Pattern Background -->
        <div class="pattern-background">
            <svg viewBox="0 0 1920 1080" preserveAspectRatio="xMidYMid slice">
                <defs>
                    <pattern id="islamicPattern" x="0" y="0" width="120" height="120" patternUnits="userSpaceOnUse">
                        <g fill="none" stroke="rgba(201, 176, 55, 0.15)" stroke-width="1">
                            <!-- Octagon and star pattern -->
                            <polygon points="30,10 50,10 60,20 60,40 50,50 30,50 20,40 20,20"/>
                            <polygon points="90,10 110,10 120,20 120,40 110,50 90,50 80,40 80,20"/>
                            <polygon points="30,70 50,70 60,80 60,100 50,110 30,110 20,100 20,80"/>
                            <polygon points="90,70 110,70 120,80 120,100 110,110 90,110 80,100 80,80"/>
                            
                            <!-- Connecting stars -->
                            <path d="M60,30 L70,25 L80,30 L75,40 L80,50 L70,55 L60,50 L65,40 Z"/>
                            <path d="M0,30 L10,25 L20,30 L15,40 L20,50 L10,55 L0,50 L5,40 Z"/>
                            <path d="M60,90 L70,85 L80,90 L75,100 L80,110 L70,115 L60,110 L65,100 Z"/>
                            <path d="M0,90 L10,85 L20,90 L15,100 L20,110 L10,115 L0,110 L5,100 Z"/>
                            
                            <!-- Circles -->
                            <circle cx="40" cy="30" r="12"/>
                            <circle cx="100" cy="30" r="12"/>
                            <circle cx="40" cy="90" r="12"/>
                            <circle cx="100" cy="90" r="12"/>
                            <circle cx="70" cy="60" r="12"/>
                            <circle cx="10" cy="60" r="12"/>
                        </g>
                        <g fill="none" stroke="rgba(201, 176, 55, 0.08)" stroke-width="0.5">
                            <!-- Secondary pattern -->
                            <path d="M40,0 L40,10 M40,50 L40,70 M40,110 L40,120"/>
                            <path d="M100,0 L100,10 M100,50 L100,70 M100,110 L100,120"/>
                            <path d="M0,30 L10,30 M50,30 L70,30 M110,30 L120,30"/>
                            <path d="M0,90 L10,90 M50,90 L70,90 M110,90 L120,90"/>
                        </g>
                    </pattern>
                    <linearGradient id="fadeGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#1a5450;stop-opacity:0.9" />
                        <stop offset="50%" style="stop-color:#1a5450;stop-opacity:0.3" />
                        <stop offset="100%" style="stop-color:#1a5450;stop-opacity:0.9" />
                    </linearGradient>
                </defs>
                <rect width="100%" height="100%" fill="url(#islamicPattern)"/>
                <rect width="100%" height="100%" fill="url(#fadeGradient)"/>
            </svg>
        </div>

        <!-- Game Floor with Islamic Pattern -->
        <div class="game-floor" id="gameFloor">
            <div class="grid-overlay"></div>
        </div>

        <!-- Distance Ring -->
        <div class="distance-ring"></div>

        <!-- Info Overlay -->
        <div class="info-overlay" id="infoOverlay"></div>


        <!-- Suggestions/Complaints Wizard Modal -->
        <div id="wizardModal" class="wizard-modal">
            <!-- Close Button -->
            <div class="close-button" onclick="closeWizard()">✕</div>
            
            <!-- Ministry Header -->
            <div class="ministry-header">
                <div class="ministry-logo">
                    <span style="font-size: 2em; color: #c9b037;">🏛️</span>
                </div>
                <div class="ministry-text">
                    <div class="ministry-name">وزارة المالية</div>
                    <div class="ministry-system">نظام دليلي الضريبي</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="wizard-progress">
                <div class="progress-step active" id="progress-1">
                    <div class="progress-circle">1</div>
                    <div class="progress-label">الفئة</div>
                </div>
                <div class="progress-step" id="progress-2">
                    <div class="progress-circle">2</div>
                    <div class="progress-label">التفاصيل</div>
                </div>
                <div class="progress-step" id="progress-3">
                    <div class="progress-circle">3</div>
                    <div class="progress-label">المرفقات</div>
                </div>
                <div class="progress-step" id="progress-4">
                    <div class="progress-circle">4</div>
                    <div class="progress-label">المراجعة</div>
                </div>
                <div class="progress-step" id="progress-5">
                    <div class="progress-circle">5</div>
                    <div class="progress-label">الإرسال</div>
                </div>
            </div>

            <!-- Step 1: Category Selection -->
            <div class="wizard-step active" id="step-1">
                <h2 class="wizard-title">
                    <span id="serviceTypeTitle">اختيار الفئة</span>
                </h2>
                <p class="wizard-subtitle">يرجى اختيار الفئة المناسبة لضمان معالجة طلبكم من الجهة المختصة</p>
                
                <div class="form-group">
                    <label class="form-label required">فئة الطلب:</label>
                    <div class="radio-group" id="categoryGroup">
                        <!-- Categories will be populated dynamically -->
                    </div>
                </div>

                <!-- Alternative Channels -->
                <!--
                    The alt-channels container holds supplemental submission channels for complaints.
                    Its contents will be populated dynamically via updateAltChannels() depending on the
                    selected category and service type. When the wizard is opened for suggestions,
                    this section remains hidden. For complaints, it defaults to showing the e‑Gov
                    portal and customs WhatsApp contact, and adds special links for tax dispute
                    or corruption categories.
                -->
                <div class="alt-channels" id="altChannels" style="display:none;">
                    <div class="alt-channels-title">
                        <span>💡</span>
                        <span>قنوات بديلة لتقديم الشكاوى</span>
                    </div>
                    <!-- Dynamic list will be injected here -->
                    <div id="altChannelsList"></div>
                </div>

                <!-- Collapsible Guidance -->
                <div class="guidance-section">
                    <div class="guidance-header" onclick="toggleGuidance(this)">
                        <span id="guidanceTitle">كيف يُعالج طلبك؟</span>
                        <span></span>
                    </div>
                    <div class="guidance-content" id="guidanceContent">
                        <!-- Content will be populated dynamically -->
                    </div>
                </div>

                <div class="wizard-nav">
                    <div class="wizard-nav-left"></div>
                    <div class="wizard-nav-right">
                        <button type="button" class="btn-next" onclick="nextStep()" disabled>التالي ←</button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Details -->
            <div class="wizard-step" id="step-2">
                <h2 class="wizard-title">تفاصيل الطلب</h2>
                <p class="wizard-subtitle">يرجى شرح طلبك بشكل واضح وموجز مع ذكر أي تفاصيل داعمة</p>
                
                <div class="form-group">
                    <!-- Assign an ID to the Arabic subject label so it can be updated dynamically -->
                    <label id="labelTitleAr" class="form-label required">عنوان الشكوى *</label>
                    <input type="text" class="form-control" id="titleAr" placeholder="اكتب عنواناً واضحاً للشكوى" required>
                    <span class="form-error">يرجى إدخال عنوان الشكوى</span>
                </div>

                <div class="form-group">
                    <label class="form-label">Title in English (اختياري)</label>
                    <input type="text" class="form-control" id="titleEn" placeholder="Enter complaint title in English">
                </div>

                <div class="form-group">
                    <!-- Assign an ID to the description label for dynamic updates -->
                    <label id="labelDesc" class="form-label required">وصف الشكوى *</label>
                    <textarea class="form-control" id="description" placeholder="اشرح تفاصيل الشكوى بوضوح..." required></textarea>
                    <span class="form-error">يرجى إدخال وصف تفصيلي</span>
                </div>

                <!-- Location Section -->
                <div class="form-group" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <label class="form-label" style="font-weight: 600; margin-bottom: 15px;">
                        <span>📍</span> معلومات الموقع
                    </label>
                    
                    <div style="margin-bottom: 15px;">
                        <button type="button" class="btn-location" onclick="getCurrentLocation()" style="padding: 10px 20px; background: #e7f5ff; border: 1px solid #1a5450; border-radius: 6px; cursor: pointer;">
                            <span>📍</span> تحديد على الخريطة باستخدام GPS
                        </button>
                        <div id="locationStatus" style="margin-top: 10px; color: #6c757d; font-size: 0.9em;"></div>
                    </div>
                    
                    <div style="display: flex; align-items: center; margin: 15px 0;">
                        <hr style="flex: 1; border-color: #dee2e6;">
                        <span style="padding: 0 15px; color: #6c757d;">أو</span>
                        <hr style="flex: 1; border-color: #dee2e6;">
                    </div>
                    
                    <div>
                        <label class="form-label">العنوان التفصيلي</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label class="form-label" style="font-size: 0.9em;">المحافظة *</label>
                                <select class="form-control" id="governorate" onchange="updateCities()">
                                    <option value="">اختر المحافظة</option>
                                    <option value="damascus">دمشق</option>
                                    <option value="aleppo">حلب</option>
                                    <option value="homs">حمص</option>
                                    <option value="hama">حماة</option>
                                    <option value="latakia">اللاذقية</option>
                                    <option value="tartous">طرطوس</option>
                                    <option value="idlib">إدلب</option>
                                    <option value="daraa">درعا</option>
                                    <option value="sweida">السويداء</option>
                                    <option value="quneitra">القنيطرة</option>
                                    <option value="deir">دير الزور</option>
                                    <option value="raqqa">الرقة</option>
                                    <option value="hasaka">الحسكة</option>
                                    <option value="damascus-countryside">ريف دمشق</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label" style="font-size: 0.9em;">المدينة/المنطقة</label>
                                <select class="form-control" id="city" disabled>
                                    <option value="">اختر المحافظة أولاً</option>
                                </select>
                            </div>
                        </div>
                        <input type="text" class="form-control" id="address" placeholder="الشارع، الحي، معالم بارزة...">
                    </div>
                </div>

                <!-- Privacy Options -->
                <div style="background: #fff4e5; border-right: 4px solid #ffc107; padding: 15px; border-radius: 6px; margin: 20px 0;">
                    <div class="checkbox-group" style="background: transparent; padding: 10px 0;">
                        <input type="checkbox" id="anonymous" onchange="toggleAnonymous()">
                        <label for="anonymous">أرغب في تقديم الشكوى بدون ذكر اسمي (شكوى مجهولة)</label>
                    </div>
                    
                    <div class="checkbox-group" style="background: transparent; padding: 10px 0;">
                        <input type="checkbox" id="publicInfo">
                        <label for="publicInfo">أوافق على عرض الشكوى في التقارير العامة (بدون معلومات شخصية)</label>
                    </div>
                    
                    <div class="checkbox-group" style="background: transparent; padding: 10px 0;">
                        <input type="checkbox" id="dataProcessing" required>
                        <label for="dataProcessing">أوافق على معالجة بياناتي الشخصية لأغراض معالجة الشكوى *</label>
                    </div>
                    
                    <div class="checkbox-group" style="background: transparent; padding: 10px 0;">
                        <input type="checkbox" id="followUp">
                        <label for="followUp">أوافق على التواصل معي لمتابعة الشكوى</label>
                    </div>
                </div>

                <div id="personalInfo">
                    <div class="form-group">
                        <label class="form-label required">الاسم الكامل *</label>
                        <input type="text" class="form-control" id="fullName" required>
                        <span class="form-error">يرجى إدخال الاسم الكامل</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">رقم الهاتف *</label>
                        <input type="tel" class="form-control" id="phone" placeholder="+963xxxxxxxxx" required>
                        <span class="form-error">يرجى إدخال رقم هاتف صحيح</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">البريد الإلكتروني</label>
                        <input type="email" class="form-control" id="email" placeholder="example@email.com">
                        <span class="form-error">يرجى إدخال بريد إلكتروني صحيح</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">الرقم الوطني</label>
                        <input type="text" class="form-control" id="nationalId" placeholder="xxxxxxxxxxx">
                    </div>
                </div>

                <div class="wizard-nav">
                    <div class="wizard-nav-left">
                        <button type="button" class="btn-prev" onclick="prevStep()">→ السابق</button>
                    </div>
                    <div class="wizard-nav-right">
                        <button type="button" class="btn-next" onclick="nextStep()">التالي ←</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Attachments -->
            <div class="wizard-step" id="step-3">
                <h2 class="wizard-title">المرفقات (اختياري)</h2>
                <p class="wizard-subtitle">يمكنك إرفاق مستندات أو صور داعمة لطلبك</p>
                
                <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="file-upload-icon">📎</div>
                    <div>انقر لإرفاق ملف أو اسحب الملفات هنا</div>
                    <div style="font-size: 0.85em; color: #6c757d; margin-top: 10px;">
                        الملفات المسموحة: PDF, JPEG, PNG, DOCX (حد أقصى 5MB لكل ملف)
                    </div>
                </div>
                <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png,.docx" style="display:none;" onchange="handleFiles(this.files)">
                
                <div class="file-list" id="fileList"></div>

                <div class="wizard-nav">
                    <div class="wizard-nav-left">
                        <button type="button" class="btn-prev" onclick="prevStep()">→ السابق</button>
                    </div>
                    <div class="wizard-nav-right">
                        <button type="button" class="btn-next" onclick="nextStep()">التالي ←</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Review -->
            <div class="wizard-step" id="step-4">
                <h2 class="wizard-title">مراجعة الطلب</h2>
                <p class="wizard-subtitle">يرجى التأكد من صحة المعلومات أدناه قبل الإرسال</p>
                
                <div class="review-section">
                    <div class="review-section-title">معلومات الطلب</div>
                    <div class="review-item">
                        <span class="review-label">نوع الطلب:</span>
                        <span class="review-value" id="reviewType"></span>
                    </div>
                    <div class="review-item">
                        <span class="review-label">الفئة:</span>
                        <span class="review-value" id="reviewCategory"></span>
                    </div>
                    <div class="review-item">
                        <span class="review-label">الموضوع:</span>
                        <span class="review-value" id="reviewSubject"></span>
                    </div>
                </div>

                <div class="review-section">
                    <div class="review-section-title">الوصف التفصيلي</div>
                    <div class="review-value" id="reviewDescription" style="white-space: pre-wrap;"></div>
                </div>

                <div class="review-section">
                    <div class="review-section-title">معلومات التواصل</div>
                    <div id="reviewPersonalInfo">
                        <div class="review-item">
                            <span class="review-label">الاسم:</span>
                            <span class="review-value" id="reviewName"></span>
                        </div>
                        <div class="review-item">
                            <span class="review-label">رقم الهاتف:</span>
                            <span class="review-value" id="reviewPhone"></span>
                        </div>
                        <div class="review-item">
                            <span class="review-label">البريد الإلكتروني:</span>
                            <span class="review-value" id="reviewEmail"></span>
                        </div>
                    </div>
                </div>

                <div class="review-section" id="reviewAttachmentsSection" style="display:none;">
                    <div class="review-section-title">المرفقات</div>
                    <div id="reviewAttachments"></div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="confirmData" onchange="toggleSubmit()">
                    <label for="confirmData">أقر بأن جميع المعلومات أعلاه صحيحة</label>
                </div>

                <div class="wizard-nav">
                    <div class="wizard-nav-left">
                        <button type="button" class="btn-prev" onclick="prevStep()">→ السابق</button>
                    </div>
                    <div class="wizard-nav-right">
                        <button type="button" class="btn-submit" onclick="submitForm()" disabled>إرسال الطلب</button>
                    </div>
                </div>
            </div>

            <!-- Step 5: Success -->
            <div class="wizard-step" id="step-5">
                <div class="success-container">
                    <div class="success-icon">✅</div>
                    <h2 class="success-title">تم استلام طلبك بنجاح!</h2>
                    <p class="success-message">
                        شكراً لتواصلكم معنا. نقدر مبادرتكم واهتمامكم.
                        <br>سيتم مراجعة طلبكم من قبل الفريق المختص وسنتواصل معكم في أقرب وقت.
                    </p>
                    
                    <div class="reference-number">
                        <div class="reference-label">رقم المرجع</div>
                        <div class="reference-value" id="referenceNumber">SYR-2025-0001</div>
                    </div>
                    
                    <p style="color: #6c757d; margin-top: 20px;">
                        يمكنكم متابعة حالة الطلب عبر الاتصال على الرقم <strong>19993</strong>
                        <br>أو استخدام الرقم المرجعي أعلاه
                    </p>
                </div>

                <div class="wizard-nav">
                    <div class="wizard-nav-left"></div>
                    <div class="wizard-nav-right">
                        <button type="button" class="btn-close" onclick="closeWizard()">إغلاق</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Central Compass -->
        <div class="compass-container">
            <!-- Ornate Outer Ring -->
            <div class="compass-ring">
                <svg viewBox="0 0 280 280">
                    <defs>
                        <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />
                            <stop offset="25%" style="stop-color:#ffed4e;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#ffd700;stop-opacity:1" />
                            <stop offset="75%" style="stop-color:#d4af37;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ffd700;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <!-- Outer decorative ring with ornate pattern -->
                    <g transform="translate(140,140)">
                        <!-- Main ring -->
                        <circle cx="0" cy="0" r="135" fill="none" stroke="url(#ringGradient)" stroke-width="3" opacity="0.9"/>
                        <!-- Decorative elements -->
                        <g id="ornament">
                            <path d="M 0,-135 L 8,-125 L 0,-115 L -8,-125 Z" fill="url(#ringGradient)"/>
                            <circle cx="0" cy="-130" r="2" fill="#ffd700"/>
                        </g>
                        <!-- Repeat ornaments around the ring -->
                        <use href="#ornament" transform="rotate(30)"/>
                        <use href="#ornament" transform="rotate(60)"/>
                        <use href="#ornament" transform="rotate(90)"/>
                        <use href="#ornament" transform="rotate(120)"/>
                        <use href="#ornament" transform="rotate(150)"/>
                        <use href="#ornament" transform="rotate(180)"/>
                        <use href="#ornament" transform="rotate(210)"/>
                        <use href="#ornament" transform="rotate(240)"/>
                        <use href="#ornament" transform="rotate(270)"/>
                        <use href="#ornament" transform="rotate(300)"/>
                        <use href="#ornament" transform="rotate(330)"/>
                    </g>
                </svg>
            </div>
            
            <!-- Glass Sphere -->
            <div class="compass-sphere"></div>
            
            <!-- Cardinal Points -->
            <div class="cardinal-points">
                <div class="cardinal-point north">ش</div>
                <div class="cardinal-point south">ج</div>
                <div class="cardinal-point east">ش</div>
                <div class="cardinal-point west">غ</div>
            </div>
            
            <!-- Compass Needle (Dalili Sword) -->
            <div class="compass-needle" id="compassNeedle">
                <svg viewBox="0 0 200 200">
                    <defs>
                        <linearGradient id="tealGradient" x1="50%" y1="0%" x2="50%" y2="100%">
                            <stop offset="0%" style="stop-color:#2a7f7e;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#4dd0e1;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#2a7f7e;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="goldGradient" x1="50%" y1="0%" x2="50%" y2="100%">
                            <stop offset="0%" style="stop-color:#c9b037;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#f9e79f;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#c9b037;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    
                    <!-- Exact Dalili Sword Design -->
                    <g transform="translate(100,100)">
                        <!-- Top sword point (teal) -->
                        <path d="M 0,-60 
                                 C -8,-52 -12,-45 -15,-35
                                 C -12,-32 -8,-28 0,-20
                                 C 8,-28 12,-32 15,-35
                                 C 12,-45 8,-52 0,-60 Z" 
                              fill="url(#tealGradient)"/>
                        
                        <!-- Right sword point (teal) -->
                        <path d="M 60,0 
                                 C 52,-8 45,-12 35,-15
                                 C 32,-12 28,-8 20,0
                                 C 28,8 32,12 35,15
                                 C 45,12 52,8 60,0 Z" 
                              fill="url(#tealGradient)"/>
                        
                        <!-- Bottom sword point (teal) - elongated for sword handle -->
                        <path d="M 0,60 
                                 C 8,52 12,45 15,35
                                 C 12,32 8,28 0,20
                                 C -8,28 -12,32 -15,35
                                 C -12,45 -8,52 0,60 Z" 
                              fill="url(#tealGradient)"/>
                        
                        <!-- Left sword point (teal) -->
                        <path d="M -60,0 
                                 C -52,8 -45,12 -35,15
                                 C -32,12 -28,8 -20,0
                                 C -28,-8 -32,-12 -35,-15
                                 C -45,-12 -52,-8 -60,0 Z" 
                              fill="url(#tealGradient)"/>
                        
                        <!-- Center diamond (gold) -->
                        <path d="M 0,-20 
                                 C -10,-15 -15,-10 -20,0
                                 C -15,10 -10,15 0,20
                                 C 10,15 15,10 20,0
                                 C 15,-10 10,-15 0,-20 Z" 
                              fill="url(#goldGradient)"/>
                        
                        <!-- Gold curved connectors -->
                        <path d="M 15,-35 
                                 Q 25,-25 35,-15" 
                              stroke="url(#goldGradient)" 
                              stroke-width="3" 
                              fill="none"
                              opacity="0.8"/>
                        
                        <path d="M 35,15 
                                 Q 25,25 15,35" 
                              stroke="url(#goldGradient)" 
                              stroke-width="3" 
                              fill="none"
                              opacity="0.8"/>
                        
                        <path d="M -15,35 
                                 Q -25,25 -35,15" 
                              stroke="url(#goldGradient)" 
                              stroke-width="3" 
                              fill="none"
                              opacity="0.8"/>
                        
                        <path d="M -35,-15 
                                 Q -25,-25 -15,-35" 
                              stroke="url(#goldGradient)" 
                              stroke-width="3" 
                              fill="none"
                              opacity="0.8"/>
                    </g>
                </svg>
            </div>
        </div>

        <!-- Player Avatar -->
        <div id="player">
            <div class="player-body"></div>
        </div>

        <!-- Service Nodes - 6 Sections Symmetrically Positioned -->
        <!-- Top Center: Tax Calculator -->
        <div class="service-container" style="top: 15%; left: 50%; transform: translateX(-50%);">
            <div class="service-node" data-service="calculator">
                <span class="node-icon">🧮</span>
                <div class="node-title">حاسبة الضرائب</div>
                <div class="node-info">
                    <div class="close-button" onclick="event.stopPropagation(); closeAllInfoBoxes()">✕</div>
                    <div class="ministry-header">
                        <div class="ministry-logo">
                            <span style="font-size: 2em; color: #c9b037;">🏛️</span>
                        </div>
                        <div class="ministry-text">
                            <div class="ministry-name">وزارة المالية</div>
                            <div class="ministry-system">نظام دليلي الضريبي</div>
                        </div>
                    </div>
                    <div class="service-icon-container">
                        <div class="service-icon-bg">
                            <span class="info-icon" style="font-size: 3em;">🧮</span>
                        </div>
                    </div>
                    <div class="node-info-title">حاسبة الضرائب</div>
                    <div class="node-info-content">أدوات حساب ضريبية متقدمة للأفراد والشركات. احسب ضريبة الدخل، ضريبة القيمة المضافة، الضريبة على الشركات واحصل على تقديرات فورية لالتزاماتك الضريبية.</div>
                    <!-- Add stopPropagation to prevent the click from bubbling up to the service node and closing the info card -->
                    <button class="service-button" onclick="event.stopPropagation(); navigateToService('/tax-calculator')">الدخول إلى الخدمة ←</button>
                    <div class="security-badge">اتصال آمن ومشفر</div>
                    <div class="info-footer">
                        <div class="footer-version">
                            <span>الإصدار 2.0.1</span>
                        </div>
                        <div class="footer-support">
                            <span>📞</span>
                            <span>الدعم الفني: 19993</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Right: Financial & Tax Law Library -->
        <div class="service-container" style="top: 30%; right: 15%;">
            <div class="service-node" data-service="library">
                <span class="node-icon">📚</span>
                <div class="node-title">مكتبة القوانين المالية والضريبية</div>
                <div class="node-info">
                    <div class="close-button" onclick="event.stopPropagation(); closeAllInfoBoxes()">✕</div>
                    <div class="ministry-header">
                        <div class="ministry-logo">
                            <span style="font-size: 2em; color: #c9b037;">🏛️</span>
                        </div>
                        <div class="ministry-text">
                            <div class="ministry-name">وزارة المالية</div>
                            <div class="ministry-system">نظام دليلي الضريبي</div>
                        </div>
                    </div>
                    <div class="service-icon-container">
                        <div class="service-icon-bg">
                            <span class="info-icon" style="font-size: 3em;">📚</span>
                        </div>
                    </div>
                    <div class="node-info-title">مكتبة القوانين المالية والضريبية</div>
                    <div class="node-info-content">قاعدة بيانات شاملة للقوانين الضريبية واللوائح المالية والسوابق القانونية. اطلع على أحدث التشريعات والقوانين الضريبية والتوجيهات التنظيمية.</div>
                    <!-- Prevent click bubbling and launch the library service (placeholder route) -->
                    <button class="service-button" onclick="event.stopPropagation(); navigateToService('/law-library')">الدخول إلى الخدمة ←</button>
                    <div class="security-badge">اتصال آمن ومشفر</div>
                    <div class="info-footer">
                        <div class="footer-version">
                            <span>الإصدار 2.0.1</span>
                        </div>
                        <div class="footer-support">
                            <span>📞</span>
                            <span>الدعم الفني: 19993</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Left: Dalili Virtual Assistant -->
        <div class="service-container" style="top: 30%; left: 15%;">
            <div class="service-node" data-service="assistant">
                <span class="node-icon">🤖</span>
                <div class="node-title">مساعد دليلي الافتراضي</div>
                <div class="node-info">
                    <div class="close-button" onclick="event.stopPropagation(); closeAllInfoBoxes()">✕</div>
                    <div class="ministry-header">
                        <div class="ministry-logo">
                            <span style="font-size: 2em; color: #c9b037;">🏛️</span>
                        </div>
                        <div class="ministry-text">
                            <div class="ministry-name">وزارة المالية</div>
                            <div class="ministry-system">نظام دليلي الضريبي</div>
                        </div>
                    </div>
                    <div class="service-icon-container">
                        <div class="service-icon-bg">
                            <span class="info-icon" style="font-size: 3em;">🤖</span>
                        </div>
                    </div>
                    <div class="node-info-title">مساعد دليلي الافتراضي</div>
                    <div class="node-info-content">مساعدك الذكي للإجابة على جميع استفساراتك الضريبية والمالية. احصل على مشورة فورية ودعم على مدار الساعة وإرشادات مخصصة لاحتياجاتك الضريبية.</div>
                    <!-- Prevent click bubbling and launch the virtual assistant service (placeholder route) -->
                    <button class="service-button" onclick="event.stopPropagation(); navigateToService('/virtual-assistant')">الدخول إلى الخدمة ←</button>
                    <div class="security-badge">اتصال آمن ومشفر</div>
                    <div class="info-footer">
                        <div class="footer-version">
                            <span>الإصدار 2.0.1</span>
                        </div>
                        <div class="footer-support">
                            <span>📞</span>
                            <span>الدعم الفني: 19993</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Right: Suggestions -->
        <div class="service-container" style="bottom: 30%; right: 15%;">
            <div class="service-node" data-service="suggestions">
                <span class="node-icon">💡</span>
                <div class="node-title">الاقتراحات</div>
                <div class="node-info">
                    <div class="close-button" onclick="event.stopPropagation(); closeAllInfoBoxes()">✕</div>
                    <div class="ministry-header">
                        <div class="ministry-logo">
                            <span style="font-size: 2em; color: #c9b037;">🏛️</span>
                        </div>
                        <div class="ministry-text">
                            <div class="ministry-name">وزارة المالية</div>
                            <div class="ministry-system">نظام دليلي الضريبي</div>
                        </div>
                    </div>
                    <div class="service-icon-container">
                        <div class="service-icon-bg">
                            <span class="info-icon" style="font-size: 3em;">💡</span>
                        </div>
                    </div>
                    <div class="node-info-title">بوابة الاقتراحات</div>
                    <div class="node-info-content">شارك أفكارك لتحسين الخدمات الضريبية واللوائح المالية. قدم اقتراحات لتحسين السياسات أو تعزيز الخدمات أو المبادرات الجديدة.</div>
                    <!-- Directly launch the suggestions wizard rather than routing through navigateToService.
                         We stop propagation to keep the parent service node from handling the click and closing the card. -->
                    <button class="service-button" onclick="event.stopPropagation(); openWizard('suggestions')">الدخول إلى الخدمة ←</button>
                    <div class="security-badge">اتصال آمن ومشفر</div>
                    <div class="info-footer">
                        <div class="footer-version">
                            <span>الإصدار 2.0.1</span>
                        </div>
                        <div class="footer-support">
                            <span>📞</span>
                            <span>الدعم الفني: 19993</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Left: Complaints -->
        <div class="service-container" style="bottom: 30%; left: 15%;">
            <div class="service-node" data-service="complaints">
                <span class="node-icon">📢</span>
                <div class="node-title">الشكاوى</div>
                <div class="node-info">
                    <div class="close-button" onclick="event.stopPropagation(); closeAllInfoBoxes()">✕</div>
                    <div class="ministry-header">
                        <div class="ministry-logo">
                            <span style="font-size: 2em; color: #c9b037;">🏛️</span>
                        </div>
                        <div class="ministry-text">
                            <div class="ministry-name">وزارة المالية</div>
                            <div class="ministry-system">نظام دليلي الضريبي</div>
                        </div>
                    </div>
                    <div class="service-icon-container">
                        <div class="service-icon-bg">
                            <span class="info-icon" style="font-size: 3em;">📢</span>
                        </div>
                    </div>
                    <div class="node-info-title">الشكاوى والحلول</div>
                    <div class="node-info-content">قدم وتابع الشكاوى حول التقييمات الضريبية أو مشاكل الخدمة أو الممارسات غير العادلة. فريقنا المخصص يضمن الحل السريع والمعاملة العادلة.</div>
                    <!-- Directly launch the complaints wizard rather than routing through navigateToService.
                         We stop propagation to prevent the click from bubbling to the service node and closing the card. -->
                    <button class="service-button" onclick="event.stopPropagation(); openWizard('complaints')">الدخول إلى الخدمة ←</button>
                    <div class="security-badge">اتصال آمن ومشفر</div>
                    <div class="info-footer">
                        <div class="footer-version">
                            <span>الإصدار 2.0.1</span>
                        </div>
                        <div class="footer-support">
                            <span>📞</span>
                            <span>الدعم الفني: 19993</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Center: News -->
        <div class="service-container" style="bottom: 15%; left: 50%; transform: translateX(-50%);">
            <div class="service-node" data-service="news">
                <span class="node-icon">📰</span>
                <div class="node-title">الأخبار</div>
                <div class="node-info">
                    <div class="close-button" onclick="event.stopPropagation(); closeAllInfoBoxes()">✕</div>
                    <div class="ministry-header">
                        <div class="ministry-logo">
                            <span style="font-size: 2em; color: #c9b037;">🏛️</span>
                        </div>
                        <div class="ministry-text">
                            <div class="ministry-name">وزارة المالية</div>
                            <div class="ministry-system">نظام دليلي الضريبي</div>
                        </div>
                    </div>
                    <div class="service-icon-container">
                        <div class="service-icon-bg">
                            <span class="info-icon" style="font-size: 3em;">📰</span>
                        </div>
                    </div>
                    <div class="node-info-title">الأخبار والتحديثات</div>
                    <div class="node-info-content">ابق على اطلاع بأحدث الأخبار الضريبية والمالية، التحديثات التنظيمية، والإعلانات الهامة من وزارة المالية. تابع التغييرات في السياسات والمواعيد النهائية المهمة.</div>
                    <!-- Prevent click bubbling and launch the news service (placeholder route) -->
                    <button class="service-button" onclick="event.stopPropagation(); navigateToService('/news')">الدخول إلى الخدمة ←</button>
                    <div class="security-badge">اتصال آمن ومشفر</div>
                    <div class="info-footer">
                        <div class="footer-version">
                            <span>الإصدار 2.0.1</span>
                        </div>
                        <div class="footer-support">
                            <span>📞</span>
                            <span>الدعم الفني: 19993</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- UI Overlay -->
        <div class="ui-overlay">
            <!-- Header -->
            <div class="game-header">
                <h1 class="game-title">دليلي</h1>
                <p class="game-subtitle">نظام الملاحة للخدمات الضريبية والمالية</p>
            </div>

            <!-- Compass Direction Display -->
            <div class="compass-direction" id="compassDirection">
                البوصلة تستشعر احتياجاتك...
            </div>

            <!-- Mobile Controls -->
            <div class="mobile-controls">
                <div class="joystick" id="joystick">
                    <div class="joystick-knob" id="joystickKnob"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Top header bar with logos.  The bar spans the full width and sits at
         the very top of the screen.  The logos scale with viewport height and
         the bar uses pointer‑events: none so it does not block interactions
         with the game. -->
    <div class="header-bar">
        <!-- Place the ministry logo on the left and the Dalili logo on the right.  The direction property on
             the container forces a left‑to‑right ordering even though the page uses rtl.  -->
        <img src="ministry-logo.png" alt="شعار وزارة المالية">
        <!-- Use the updated transparent PNG version of the Dalili logo to avoid any background. -->
        <img src="dalili-logo-transparent-new.png" alt="شعار دليلي">
    </div>

    <script>
        // Game State
        const gameState = {
            player: {
                x: window.innerWidth / 2,
                y: window.innerHeight / 2,
                speed: 4,
                direction: 0,
                lastX: window.innerWidth / 2,
                lastY: window.innerHeight / 2
            },
            keys: {},
            nearestService: null,
            selectedService: null,
            compassAngle: 0,
            targetAngle: 0,
            currentAngle: 0
        };

        // Service Information
        const serviceInfo = {
            calculator: {
                icon: '🧮',
                title: 'حاسبة الضرائب',
                content: 'أدوات حساب ضريبية متقدمة للأفراد والشركات. احسب ضريبة الدخل، ضريبة القيمة المضافة، الضريبة على الشركات واحصل على تقديرات فورية لالتزاماتك الضريبية.',
                route: '/tax-calculator'
            },
            library: {
                icon: '📚',
                title: 'مكتبة القوانين المالية والضريبية',
                content: 'قاعدة بيانات شاملة للقوانين الضريبية واللوائح المالية والسوابق القانونية. اطلع على أحدث التشريعات والقوانين الضريبية والتوجيهات التنظيمية.',
                route: '/law-library'
            },
            suggestions: {
                icon: '💡',
                title: 'بوابة الاقتراحات',
                content: 'شارك أفكارك لتحسين الخدمات الضريبية واللوائح المالية. قدم اقتراحات لتحسين السياسات أو تعزيز الخدمات أو المبادرات الجديدة.',
                route: '/suggestions'
            },
            complaints: {
                icon: '📢',
                title: 'الشكاوى والحلول',
                content: 'قدم وتابع الشكاوى حول التقييمات الضريبية أو مشاكل الخدمة أو الممارسات غير العادلة. فريقنا المخصص يضمن الحل السريع والمعاملة العادلة.',
                route: '/complaints'
            },
            assistant: {
                icon: '🤖',
                title: 'مساعد دليلي الافتراضي',
                content: 'مساعدك الذكي للإجابة على جميع استفساراتك الضريبية والمالية. احصل على مشورة فورية ودعم على مدار الساعة وإرشادات مخصصة لاحتياجاتك الضريبية.',
                route: '/virtual-assistant'
            },
            news: {
                icon: '📰',
                title: 'الأخبار والتحديثات',
                content: 'ابق على اطلاع بأحدث الأخبار الضريبية والمالية، التحديثات التنظيمية، والإعلانات الهامة من وزارة المالية. تابع التغييرات في السياسات والمواعيد النهائية المهمة.',
                route: '/news'
            }
        };

        // Initialize
        function init() {
            createGrid();
            createStars();
            createParticles();
            setupEventListeners();
            gameLoop();
        }

        // Create Grid with Islamic Pattern
        function createGrid() {
            const floor = document.getElementById('gameFloor');
            
            // Create Islamic pattern overlay
            const patternOverlay = document.createElement('div');
            patternOverlay.style.cssText = `
                position: absolute;
                width: 100%;
                height: 100%;
                opacity: 0.4;
                background-image: repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 35px,
                    rgba(77, 208, 225, 0.05) 35px,
                    rgba(77, 208, 225, 0.05) 36px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 35px,
                    rgba(77, 208, 225, 0.05) 35px,
                    rgba(77, 208, 225, 0.05) 36px
                );
            `;
            floor.appendChild(patternOverlay);
            
            // Add subtle grid lines for depth
            for (let i = 0; i <= 20; i++) {
                // Horizontal lines
                const hLine = document.createElement('div');
                hLine.style.cssText = `
                    position: absolute;
                    width: 100%;
                    height: 1px;
                    top: ${(i / 20) * 100}%;
                    background: rgba(77, 208, 225, 0.08);
                    opacity: ${0.3 - (Math.abs(i - 10) / 20) * 0.2};
                `;
                floor.appendChild(hLine);
                
                // Vertical lines
                const vLine = document.createElement('div');
                vLine.style.cssText = `
                    position: absolute;
                    width: 1px;
                    height: 100%;
                    left: ${(i / 20) * 100}%;
                    background: rgba(77, 208, 225, 0.08);
                    opacity: ${0.3 - (Math.abs(i - 10) / 20) * 0.2};
                `;
                floor.appendChild(vLine);
            }
        }

        // Create Stars
        function createStars() {
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                document.getElementById('gameCanvas').appendChild(star);
            }
        }

        // Create Particles
        function createParticles() {
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                document.getElementById('gameCanvas').appendChild(particle);
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Keyboard
            document.addEventListener('keydown', (e) => {
                gameState.keys[e.key.toLowerCase()] = true;
                
                if (e.key === ' ') {
                    e.preventDefault();
                    selectService();
                }
                
                if (e.key === 'Escape') {
                    closeAllInfoBoxes();
                }
            });
            
            document.addEventListener('keyup', (e) => {
                gameState.keys[e.key.toLowerCase()] = false;
            });
            
            // Service node clicks
            document.querySelectorAll('.service-node').forEach(node => {
                node.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const service = node.dataset.service;
                    showServiceInfo(node, service);
                });
            });
            
            // Close info on overlay click
            document.getElementById('infoOverlay').addEventListener('click', closeAllInfoBoxes);
            
            // Mobile controls
            setupMobileControls();
        }

        // Close all info boxes
        function closeAllInfoBoxes() {
            document.querySelectorAll('.service-node').forEach(node => {
                node.classList.remove('selected');
            });
            document.getElementById('infoOverlay').classList.remove('active');
            gameState.selectedService = null;
        }

        // Show Service Info
        function showServiceInfo(node, service) {
            // Prevent multiple modals
            if (gameState.selectedService === service) {
                closeAllInfoBoxes();
                return;
            }
            
            // Close any open info boxes first
            closeAllInfoBoxes();
            
            // Small delay for smooth transition
            setTimeout(() => {
                // Add selected class to show info
                node.classList.add('selected');
                document.getElementById('infoOverlay').classList.add('active');
                gameState.selectedService = service;
                
                // Create selection effect
                const rect = node.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                const burst = document.createElement('div');
                burst.style.cssText = `
                    position: absolute;
                    width: 200px;
                    height: 200px;
                    border: 3px solid #4dd0e1;
                    border-radius: 50%;
                    left: ${centerX}px;
                    top: ${centerY}px;
                    transform: translate(-50%, -50%) scale(0);
                    opacity: 1;
                    pointer-events: none;
                    z-index: 99;
                `;
                document.getElementById('gameCanvas').appendChild(burst);
                
                requestAnimationFrame(() => {
                    burst.style.transition = 'all 0.6s ease-out';
                    burst.style.transform = 'translate(-50%, -50%) scale(2)';
                    burst.style.opacity = '0';
                });
                
                setTimeout(() => burst.remove(), 600);
            }, 50);
        }

        // Route to service page
        let isNavigating = false;
        
function navigateToService(route) {
    /*
     * This function controls what happens when a user clicks the primary action button
     * inside a service info card.  For the suggestions and complaints services we
     * launch our custom wizard directly.  For all other services, the original
     * application attempted to change the browser location to a new path (e.g.
     * `/law-library`), however in this single‑file demo there are no such pages.
     * To provide clear feedback and avoid the appearance of a glitch, we instead
     * show a friendly alert when a user tries to access one of the other
     * services.  This prevents the overlay from simply closing without any
     * response, which was perceived as a bug.  Should future versions of the
     * application include actual routes for these services, this handler can
     * be adjusted accordingly.
     */

    // Suggestions or complaints trigger the step‑by‑step wizard
    if (route === '/suggestions' || route === '/complaints') {
        const serviceType = route === '/suggestions' ? 'suggestions' : 'complaints';
        openWizard(serviceType);
        return;
    }

    // For any other route, politely inform the user and keep them on the current page
    if (!route || route === '#' || typeof route !== 'string') {
        alert('⚠️ الخدمة غير متاحة حالياً');
        return;
    }

    // Show an informational message since external pages are not part of this demo
    alert('هذه الخدمة غير متاحة في النسخة الحالية من التطبيق. سيتم توفيرها في تحديث قادم.');
    // Optionally, you could close the info card after informing the user
    closeAllInfoBoxes();
}

        // Add spin animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // Mobile Controls
        function setupMobileControls() {
            const joystick = document.getElementById('joystick');
            const knob = document.getElementById('joystickKnob');
            
            if (!joystick) return;
            
            let touching = false;
            
            joystick.addEventListener('touchstart', (e) => {
                touching = true;
                handleTouch(e.touches[0]);
            });
            
            joystick.addEventListener('touchmove', (e) => {
                if (touching) {
                    e.preventDefault();
                    handleTouch(e.touches[0]);
                }
            });
            
            joystick.addEventListener('touchend', () => {
                touching = false;
                knob.style.transform = 'translate(-50%, -50%)';
                Object.keys(gameState.keys).forEach(key => {
                    gameState.keys[key] = false;
                });
            });
            
            function handleTouch(touch) {
                const rect = joystick.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const x = touch.clientX - centerX;
                const y = touch.clientY - centerY;
                
                const distance = Math.min(35, Math.sqrt(x * x + y * y));
                const angle = Math.atan2(y, x);
                
                const knobX = Math.cos(angle) * distance;
                const knobY = Math.sin(angle) * distance;
                
                knob.style.transform = `translate(calc(-50% + ${knobX}px), calc(-50% + ${knobY}px))`;
                
                gameState.keys['arrowright'] = knobX > 15;
                gameState.keys['arrowleft'] = knobX < -15;
                gameState.keys['arrowdown'] = knobY > 15;
                gameState.keys['arrowup'] = knobY < -15;
            }
        }

        // Game Loop
        function gameLoop() {
            updatePlayer();
            updateCompass();
            checkServiceProximity();
            requestAnimationFrame(gameLoop);
        }

        // Update Player
        function updatePlayer() {
            const player = document.getElementById('player');
            let dx = 0, dy = 0;
            
            if (gameState.keys['arrowup'] || gameState.keys['w']) dy = -gameState.player.speed;
            if (gameState.keys['arrowdown'] || gameState.keys['s']) dy = gameState.player.speed;
            if (gameState.keys['arrowleft'] || gameState.keys['a']) dx = -gameState.player.speed;
            if (gameState.keys['arrowright'] || gameState.keys['d']) dx = gameState.player.speed;
            
            // Only update if moving
            if (dx !== 0 || dy !== 0) {
                gameState.player.x += dx;
                gameState.player.y += dy;
                
                // Calculate movement direction for compass
                const angle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                gameState.player.direction = angle;
                
                // Keep in bounds
                gameState.player.x = Math.max(20, Math.min(window.innerWidth - 20, gameState.player.x));
                gameState.player.y = Math.max(20, Math.min(window.innerHeight - 20, gameState.player.y));
                
                player.style.left = gameState.player.x + 'px';
                player.style.top = gameState.player.y + 'px';
                
                // Store last position
                gameState.player.lastX = gameState.player.x;
                gameState.player.lastY = gameState.player.y;
            }
        }

        // Update Compass Needle
        function updateCompass() {
            const needle = document.getElementById('compassNeedle');
            
            // Get current movement
            let dx = 0, dy = 0;
            if (gameState.keys['arrowup'] || gameState.keys['w']) dy = -1;
            if (gameState.keys['arrowdown'] || gameState.keys['s']) dy = 1;
            if (gameState.keys['arrowleft'] || gameState.keys['a']) dx = -1;
            if (gameState.keys['arrowright'] || gameState.keys['d']) dx = 1;
            
            // INSTANT response when moving
            if (dx !== 0 || dy !== 0) {
                // Calculate angle based on movement direction - IMMEDIATE
                const moveAngle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                
                // INSTANT rotation - no smoothing when moving
                needle.style.transform = `translate(-50%, -50%) rotate(${moveAngle}deg)`;
                gameState.currentAngle = moveAngle;
                
                // Update direction text immediately
                const directionText = document.getElementById('compassDirection');
                let directionName = '';
                
                // Determine cardinal/intercardinal direction
                const normalizedAngle = ((moveAngle % 360) + 360) % 360;
                if (normalizedAngle >= 337.5 || normalizedAngle < 22.5) directionName = 'الشمال';
                else if (normalizedAngle >= 22.5 && normalizedAngle < 67.5) directionName = 'الشمال الشرقي';
                else if (normalizedAngle >= 67.5 && normalizedAngle < 112.5) directionName = 'الشرق';
                else if (normalizedAngle >= 112.5 && normalizedAngle < 157.5) directionName = 'الجنوب الشرقي';
                else if (normalizedAngle >= 157.5 && normalizedAngle < 202.5) directionName = 'الجنوب';
                else if (normalizedAngle >= 202.5 && normalizedAngle < 247.5) directionName = 'الجنوب الغربي';
                else if (normalizedAngle >= 247.5 && normalizedAngle < 292.5) directionName = 'الغرب';
                else if (normalizedAngle >= 292.5 && normalizedAngle < 337.5) directionName = 'الشمال الغربي';
                
                directionText.innerHTML = `التحرك نحو <strong>${directionName}</strong>`;
                directionText.style.color = '#4dd0e1';
            } else {
                // FAST response to nearby services when stopped
                const services = document.querySelectorAll('.service-node');
                let nearestNode = null;
                let minDistance = Infinity;
                
                services.forEach(node => {
                    const rect = node.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    const distance = Math.sqrt(
                        Math.pow(gameState.player.x - centerX, 2) + 
                        Math.pow(gameState.player.y - centerY, 2)
                    );
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestNode = node;
                    }
                });
                
                let targetAngle = gameState.currentAngle;
                
                if (nearestNode && minDistance < 300) {
                    // SWIFT rotation to nearest service
                    const rect = nearestNode.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    targetAngle = Math.atan2(
                        centerY - gameState.player.y,
                        centerX - gameState.player.x
                    ) * (180 / Math.PI) + 90;
                    
                    const info = serviceInfo[nearestNode.dataset.service];
                    const directionText = document.getElementById('compassDirection');
                    if (minDistance < 150) {
                        directionText.innerHTML = `تم اكتشاف <strong>${info.title}</strong> - اضغط مسافة`;
                        directionText.style.color = '#ffd700';
                    } else {
                        directionText.innerHTML = `يشير إلى: <strong>${info.title}</strong>`;
                        directionText.style.color = '#4dd0e1';
                    }
                    
                    // Fast smooth transition to service (0.3x speed)
                    const angleDiff = targetAngle - gameState.currentAngle;
                    const shortestAngle = ((angleDiff % 360) + 540) % 360 - 180;
                    gameState.currentAngle += shortestAngle * 0.3;
                    needle.style.transform = `translate(-50%, -50%) rotate(${gameState.currentAngle}deg)`;
                } else {
                    // Return to north when no services nearby - medium speed
                    const angleDiff = 0 - gameState.currentAngle;
                    const shortestAngle = ((angleDiff % 360) + 540) % 360 - 180;
                    gameState.currentAngle += shortestAngle * 0.2;
                    needle.style.transform = `translate(-50%, -50%) rotate(${gameState.currentAngle}deg)`;
                    
                    document.getElementById('compassDirection').innerHTML = 'تنقل لاستكشاف الخدمات الضريبية والمالية';
                    document.getElementById('compassDirection').style.color = '#4dd0e1';
                }
            }
            
            gameState.compassAngle = gameState.currentAngle;
        }

        // Check Service Proximity
        function checkServiceProximity() {
            const services = document.querySelectorAll('.service-node');
            
            services.forEach(node => {
                const rect = node.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                const distance = Math.sqrt(
                    Math.pow(gameState.player.x - centerX, 2) + 
                    Math.pow(gameState.player.y - centerY, 2)
                );
                
                if (distance < 150 && !node.classList.contains('selected')) {
                    node.classList.add('active');
                } else if (!node.classList.contains('selected')) {
                    node.classList.remove('active');
                }
            });
        }

        // Select Service
        function selectService() {
            const services = document.querySelectorAll('.service-node');
            
            services.forEach(node => {
                const rect = node.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                const distance = Math.sqrt(
                    Math.pow(gameState.player.x - centerX, 2) + 
                    Math.pow(gameState.player.y - centerY, 2)
                );
                
                if (distance < 150) {
                    showServiceInfo(node, node.dataset.service);
                }
            });
        }

        // Initialize on load
        window.addEventListener('load', init);
        
        // Handle resize
        window.addEventListener('resize', () => {
            gameState.player.x = Math.min(gameState.player.x, window.innerWidth - 20);
            gameState.player.y = Math.min(gameState.player.y, window.innerHeight - 20);
        });

        // ============ WIZARD FUNCTIONALITY ============
        
        // Wizard State
        const wizardState = {
            currentStep: 1,
            serviceType: null, // 'suggestions' or 'complaints'
            formData: {
                category: null,
                subject: '',
                description: '',
                anonymous: false,
                fullName: '',
                phone: '',
                email: '',
                attachments: []
            }
        };

        // Service Categories
        const categories = {
            suggestions: [
                { value: 'policies', label: 'تحسين السياسات الضريبية', icon: '📋' },
                { value: 'eservices', label: 'تطوير الخدمات الإلكترونية', icon: '💻' },
                { value: 'initiatives', label: 'مبادرات أو حملات جديدة', icon: '🚀' },
                { value: 'other', label: 'أخرى', icon: '📝' }
            ],
            complaints: [
                { value: 'tax_dispute', label: 'نزاع أو اعتراض على تقييم ضريبي', icon: '⚖️' },
                { value: 'service_issues', label: 'مشاكل في الخدمات أو المعاملات', icon: '⚠️' },
                { value: 'staff_conduct', label: 'سلوك موظف أو معاملة غير لائقة', icon: '👤' },
                { value: 'corruption', label: 'بلاغ عن فساد أو احتيال', icon: '🚨' },
                { value: 'other', label: 'أخرى', icon: '📝' }
            ]
        };

        // Open Wizard
        function openWizard(type) {
            wizardState.serviceType = type;
            wizardState.currentStep = 1;

            /*
             * Close any currently open service info boxes BEFORE showing the wizard.
             * Previously, we activated the overlay and then called closeAllInfoBoxes(),
             * which inadvertently removed the overlay class and prevented the wizard
             * from appearing. Here we first close any info boxes (which also removes
             * the overlay's "active" class), then re‑activate the overlay for the
             * wizard. This ensures the wizard modal displays correctly.
             */
            closeAllInfoBoxes();

            // Show overlay and modal
            document.getElementById('infoOverlay').classList.add('active');
            document.getElementById('wizardModal').style.display = 'block';

            // Setup Step 1
            setupStep1(type);

            // Update labels for step 2 based on service type
            updateStep2Labels();

            // Update progress
            updateProgress(1);

            // Pause game
            gameState.modalOpen = true;
        }

        // Setup Step 1 - Category Selection
        function setupStep1(type) {
            const isComplaint = type === 'complaints';
            const title = isComplaint ? 'بوابة الشكاوى - اختيار الفئة' : 'بوابة الاقتراحات - اختيار الفئة';
            
            document.getElementById('serviceTypeTitle').textContent = title;
            
            // Show/hide alternative channels
            document.getElementById('altChannels').style.display = isComplaint ? 'block' : 'none';
            
            // Update guidance content
            const guidanceTitle = isComplaint ? 'ماذا يحدث بعد تقديم الشكوى؟' : 'كيف يُعالج اقتراحك؟';
            const guidanceText = isComplaint 
                ? 'ستُرسل شكواك بشكل آمن إلى الجهة المختصة في الوزارة. سنضمن سريتها ونتابع مع القسم المعني للتحقق وإيجاد الحل المناسب. قد نتواصل معك إذا احتجنا إلى معلومات إضافية، وسيتم إعلامك بأي إجراءات تُتخذ بشأن شكواك.'
                : 'بعد تقديم اقتراحك، ستقوم لجنة مختصة في وزارة المالية بمراجعته بعناية. قد يتم التواصل معك للحصول على إيضاحات إضافية إذا لزم الأمر. نقدر مبادرتك وسنحيطك علماً بأي تطورات حول اقتراحك.';
            
            document.getElementById('guidanceTitle').textContent = guidanceTitle;
            document.getElementById('guidanceContent').textContent = guidanceText;
            
            // Populate categories
            const categoryGroup = document.getElementById('categoryGroup');
            categoryGroup.innerHTML = '';
            
            const categoryList = categories[type];
            categoryList.forEach(cat => {
                const option = document.createElement('div');
                option.className = 'radio-option';
                option.innerHTML = `
                    <input type="radio" name="category" value="${cat.value}" id="cat_${cat.value}" onchange="selectCategory('${cat.value}')">
                    <label for="cat_${cat.value}" style="cursor: pointer; display: flex; align-items: center; gap: 10px; flex: 1;">
                        <span style="font-size: 1.3em;">${cat.icon}</span>
                        <span>${cat.label}</span>
                    </label>
                `;
                categoryGroup.appendChild(option);
            });

            // Reset selected category and update alternative channels on step initialization
            wizardState.formData.category = null;
            updateAltChannels();
        }

        // Select Category
        function selectCategory(value) {
            wizardState.formData.category = value;
            
            // Update visual selection
            document.querySelectorAll('.radio-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.closest('.radio-option').classList.add('selected');
            
            // Enable next button
            document.querySelector('#step-1 .btn-next').disabled = false;
            
            // Special handling for corruption reports
            if (value === 'corruption') {
                // Will auto-enable anonymous in step 2
                wizardState.formData.anonymous = true;
            }

            // Update alternative channels whenever category changes
            updateAltChannels();
        }

        // Toggle Guidance
        function toggleGuidance(header) {
            header.classList.toggle('open');
            header.nextElementSibling.classList.toggle('open');
        }

        // Toggle Anonymous
        function toggleAnonymous() {
            const isAnonymous = document.getElementById('anonymous').checked;
            wizardState.formData.anonymous = isAnonymous;
            
            const personalInfo = document.getElementById('personalInfo');
            if (isAnonymous) {
                personalInfo.style.opacity = '0.5';
                personalInfo.querySelectorAll('input').forEach(input => {
                    input.disabled = true;
                    input.removeAttribute('required');
                });
            } else {
                personalInfo.style.opacity = '1';
                personalInfo.querySelectorAll('input').forEach(input => {
                    input.disabled = false;
                    if (input.id !== 'email') {
                        input.setAttribute('required', 'required');
                    }

        /*
         * Update the Arabic labels, placeholders and privacy option text in
         * Step 2 depending on whether the wizard is handling suggestions
         * or complaints. Suggestions and complaints share the same form
         * fields, but the labels and placeholders should reflect the
         * appropriate terminology (e.g. "عنوان الاقتراح" vs "عنوان الشكوى").
         */
        function updateStep2Labels() {
            const isSuggestion = wizardState.serviceType === 'suggestions';
            // Update subject (title) label and placeholder
            const labelTitle = document.getElementById('labelTitleAr');
            const titleInput = document.getElementById('titleAr');
            if (labelTitle && titleInput) {
                labelTitle.textContent = isSuggestion ? 'عنوان الاقتراح *' : 'عنوان الشكوى *';
                titleInput.placeholder = isSuggestion ? 'اكتب عنواناً واضحاً للاقتراح' : 'اكتب عنواناً واضحاً للشكوى';
            }
            // Update description label and placeholder
            const labelDesc = document.getElementById('labelDesc');
            const descInput = document.getElementById('description');
            if (labelDesc && descInput) {
                labelDesc.textContent = isSuggestion ? 'وصف الاقتراح *' : 'وصف الشكوى *';
                descInput.placeholder = isSuggestion ? 'اشرح تفاصيل الاقتراح بوضوح...' : 'اشرح تفاصيل الشكوى بوضوح...';
            }
            // Update privacy option labels
            const anonymousLabel = document.querySelector('label[for="anonymous"]');
            const publicInfoLabel = document.querySelector('label[for="publicInfo"]');
            const dataProcessingLabel = document.querySelector('label[for="dataProcessing"]');
            const followUpLabel = document.querySelector('label[for="followUp"]');
            if (anonymousLabel) {
                anonymousLabel.textContent = isSuggestion ? 'أرغب في تقديم الاقتراح بدون ذكر اسمي (اقتراح مجهول)' : 'أرغب في تقديم الشكوى بدون ذكر اسمي (شكوى مجهولة)';
            }
            if (publicInfoLabel) {
                publicInfoLabel.textContent = isSuggestion ? 'أوافق على عرض الاقتراح في التقارير العامة (بدون معلومات شخصية)' : 'أوافق على عرض الشكوى في التقارير العامة (بدون معلومات شخصية)';
            }
            if (dataProcessingLabel) {
                dataProcessingLabel.textContent = isSuggestion ? 'أوافق على معالجة بياناتي الشخصية لأغراض معالجة الاقتراح *' : 'أوافق على معالجة بياناتي الشخصية لأغراض معالجة الشكوى *';
            }
            if (followUpLabel) {
                followUpLabel.textContent = isSuggestion ? 'أوافق على التواصل معي لمتابعة الاقتراح' : 'أوافق على التواصل معي لمتابعة الشكوى';
            }
        }

        /*
         * Update the list of alternative channels based on the current
         * service type and selected category. This function will show
         * relevant links for submitting complaints through other official
         * channels, such as the e‑government portal or the customs WhatsApp
         * line. For certain categories (e.g. tax dispute, corruption) it
         * includes special links to the appropriate services (e.g. tax
         * objection service, COFC/CASI). If the wizard is for suggestions,
         * the alt-channels section remains hidden.
         */
        function updateAltChannels() {
            const altContainer = document.getElementById('altChannels');
            const list = document.getElementById('altChannelsList');
            if (!altContainer || !list) return;

            // Only show alternative channels for complaints
            if (wizardState.serviceType !== 'complaints') {
                altContainer.style.display = 'none';
                list.innerHTML = '';
                return;
            }
            // Always show container for complaints
            altContainer.style.display = 'block';

            const items = [];
            // Base channels available for all complaints
            items.push(`
                <div class="alt-channel-item">
                    <span>📌</span>
                    <span>يمكن تقديم الشكاوى عبر <a href="https://www.egov.sy/service/ar/4700/0/%D8%AA%D9%82%D8%AF%D9%8A%D9%85%2B%D8%B4%D9%83%D9%88%D9%89%2B%D8%A7%D9%84%D9%83%D8%AA%D8%B1%D9%88%D9%86%D9%8A%D8%A9.html" target="_blank">بوابة الحكومة الإلكترونية</a></span>
                </div>
            `);
            items.push(`
                <div class="alt-channel-item">
                    <span>📱</span>
                    <span>للشكاوى الجمركية: واتساب <strong>0969999546</strong></span>
                </div>
            `);
            // Additional channels based on category
            switch (wizardState.formData.category) {
                case 'tax_dispute':
                    items.push(`
                        <div class="alt-channel-item">
                            <span>⚖️</span>
                            <span>نزاع ضريبي؟ ابدأ من <a href="https://www.syriantax.gov.sy/?category_id=143&id=274&lang=ar&page=show_det" target="_blank">خدمة الاعتراض على تكليف مؤقت</a></span>
                        </div>
                    `);
                    break;
                case 'corruption':
                    items.push(`
                        <div class="alt-channel-item">
                            <span>📝</span>
                            <span>إبلاغ عن فساد؟ يمكنك التواصل مع <a href="https://cofc.gov.sy/index.php?dir=complaints&ex=2&lang=1&page=send" target="_blank">الجهاز المركزي للرقابة المالية</a> أو <a href="https://www.casi.gov.sy/node15/arabic/index.php?node=70" target="_blank">الهيئة المركزية للرقابة والتفتيش</a></span>
                        </div>
                    `);
                    break;
                default:
                    // no extra items for other categories
                    break;
            }
            list.innerHTML = items.join('');
        }
                });
            }
        }

        // Handle File Upload
        function handleFiles(files) {
            const fileList = document.getElementById('fileList');
            
            for (let file of files) {
                // Check file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert(`الملف ${file.name} يتجاوز الحد الأقصى المسموح (5MB)`);
                    continue;
                }
                
                // Add to formData
                wizardState.formData.attachments.push(file);
                
                // Display file
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-name">
                        <span>📄</span>
                        <span>${file.name}</span>
                        <span style="color: #6c757d; font-size: 0.85em;">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <span class="file-remove" onclick="removeFile('${file.name}')">🗑️</span>
                `;
                fileList.appendChild(fileItem);
            }
        }

        // Remove File
        function removeFile(fileName) {
            wizardState.formData.attachments = wizardState.formData.attachments.filter(f => f.name !== fileName);
            
            // Remove from display
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach(item => {
                if (item.textContent.includes(fileName)) {
                    item.remove();
                }
            });
        }

        // Validate Current Step
        function validateStep(step) {
            switch(step) {
                case 1:
                    return wizardState.formData.category !== null;
                    
                case 2:
                    const description = document.getElementById('description').value.trim();
                    if (!description) {
                        document.getElementById('description').classList.add('error');
                        return false;
                    }
                    
                    if (!wizardState.formData.anonymous) {
                        const fullName = document.getElementById('fullName').value.trim();
                        const phone = document.getElementById('phone').value.trim();
                        
                        if (!fullName) {
                            document.getElementById('fullName').classList.add('error');
                            return false;
                        }
                        
                        if (!phone || !/^09\d{8}$/.test(phone)) {
                            document.getElementById('phone').classList.add('error');
                            return false;
                        }
                        
                        const email = document.getElementById('email').value.trim();
                        if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                            document.getElementById('email').classList.add('error');
                            return false;
                        }
                    }
                    
                    // Save data
                    // Use the Arabic title field (titleAr) as the subject field for both suggestions and complaints.
                    const titleVal = document.getElementById('titleAr').value.trim();
                    wizardState.formData.subject = titleVal;
                    wizardState.formData.description = description;
                    if (!wizardState.formData.anonymous) {
                        wizardState.formData.fullName = document.getElementById('fullName').value.trim();
                        wizardState.formData.phone = document.getElementById('phone').value.trim();
                        wizardState.formData.email = document.getElementById('email').value.trim();
                    }
                    
                    return true;
                    
                case 3:
                    return true; // Attachments are optional
                    
                case 4:
                    return document.getElementById('confirmData').checked;
                    
                default:
                    return true;
            }
        }

        // Next Step
        function nextStep() {
            if (!validateStep(wizardState.currentStep)) {
                return;
            }
            
            // Clear errors
            document.querySelectorAll('.form-control.error').forEach(el => {
                el.classList.remove('error');
            });
            
            // Hide current step
            document.getElementById(`step-${wizardState.currentStep}`).classList.remove('active');
            
            // Move to next step
            wizardState.currentStep++;
            
            // Special handling for step 4 (Review)
            if (wizardState.currentStep === 4) {
                populateReview();
            }
            
            // Show next step
            document.getElementById(`step-${wizardState.currentStep}`).classList.add('active');
            
            // Update progress
            updateProgress(wizardState.currentStep);
        }

        // Previous Step
        function prevStep() {
            // Hide current step
            document.getElementById(`step-${wizardState.currentStep}`).classList.remove('active');
            
            // Move to previous step
            wizardState.currentStep--;
            
            // Show previous step
            document.getElementById(`step-${wizardState.currentStep}`).classList.add('active');
            
            // Update progress
            updateProgress(wizardState.currentStep);
        }

        // Update Progress Bar
        function updateProgress(step) {
            for (let i = 1; i <= 5; i++) {
                const progressStep = document.getElementById(`progress-${i}`);
                progressStep.classList.remove('active', 'completed');
                
                if (i < step) {
                    progressStep.classList.add('completed');
                } else if (i === step) {
                    progressStep.classList.add('active');
                }
            }
        }

        // Populate Review
        function populateReview() {
            const isComplaint = wizardState.serviceType === 'complaints';
            const categoryList = categories[wizardState.serviceType];
            const selectedCategory = categoryList.find(c => c.value === wizardState.formData.category);
            
            document.getElementById('reviewType').textContent = isComplaint ? 'شكوى' : 'اقتراح';
            document.getElementById('reviewCategory').textContent = selectedCategory ? selectedCategory.label : '';
            document.getElementById('reviewSubject').textContent = wizardState.formData.subject || 'غير محدد';
            document.getElementById('reviewDescription').textContent = wizardState.formData.description;
            
            if (wizardState.formData.anonymous) {
                document.getElementById('reviewPersonalInfo').innerHTML = '<div style="color: #6c757d;">سيتم إرسال الطلب بدون اسم (مجهول)</div>';
            } else {
                document.getElementById('reviewName').textContent = wizardState.formData.fullName;
                document.getElementById('reviewPhone').textContent = wizardState.formData.phone;
                document.getElementById('reviewEmail').textContent = wizardState.formData.email || 'غير محدد';
            }
            
            // Attachments
            if (wizardState.formData.attachments.length > 0) {
                document.getElementById('reviewAttachmentsSection').style.display = 'block';
                const attachmentsList = wizardState.formData.attachments.map(f => `📎 ${f.name}`).join('<br>');
                document.getElementById('reviewAttachments').innerHTML = attachmentsList;
            } else {
                document.getElementById('reviewAttachmentsSection').style.display = 'none';
            }
        }

        // Toggle Submit Button
        function toggleSubmit() {
            const submitBtn = document.querySelector('#step-4 .btn-submit');
            submitBtn.disabled = !document.getElementById('confirmData').checked;
        }

        // Submit Form
        function submitForm() {
            // Show loading state
            const submitBtn = document.querySelector('#step-4 .btn-submit');
            submitBtn.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">⏳</span> جاري الإرسال...';
            submitBtn.disabled = true;
            
            // Simulate API call
            setTimeout(() => {
                // Generate reference number
                const refNumber = `SYR-${new Date().getFullYear()}-${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}`;
                document.getElementById('referenceNumber').textContent = refNumber;
                
                // Move to success step
                document.getElementById(`step-${wizardState.currentStep}`).classList.remove('active');
                wizardState.currentStep = 5;
                document.getElementById(`step-${wizardState.currentStep}`).classList.add('active');
                updateProgress(wizardState.currentStep);
                
                // Reset form for next use
                resetWizard();
            }, 1500);
        }

        // Close Wizard
        function closeWizard() {
            document.getElementById('infoOverlay').classList.remove('active');
            document.getElementById('wizardModal').style.display = 'none';
            
            // Reset wizard
            resetWizard();
            
            // Resume game
            gameState.modalOpen = false;
        }

        // Reset Wizard
        function resetWizard() {
            wizardState.currentStep = 1;
            wizardState.formData = {
                category: null,
                subject: '',
                description: '',
                anonymous: false,
                fullName: '',
                phone: '',
                email: '',
                attachments: []
            };
            
            // Clear all form fields
            document.querySelectorAll('.form-control').forEach(input => {
                input.value = '';
                input.classList.remove('error');
            });
            
            document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
                input.checked = false;
            });
            
            document.getElementById('fileList').innerHTML = '';
            
            // Reset steps
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById('step-1').classList.add('active');
            
            // Reset buttons
            document.querySelector('#step-1 .btn-next').disabled = true;
            document.querySelector('#step-4 .btn-submit').innerHTML = 'إرسال الطلب';
            document.querySelector('#step-4 .btn-submit').disabled = true;
        }
    </script>
</body>
</html>
